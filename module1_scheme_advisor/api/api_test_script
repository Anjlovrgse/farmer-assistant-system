"""
API Test Script
===============
Comprehensive testing of the Flask API
"""

import requests
import json
import time

# Configuration
BASE_URL = "http://127.0.0.1:5000"
TIMEOUT = 10  # seconds

# Colors for terminal output
class Colors:
    GREEN = '\033[92m'
    RED = '\033[91m'
    YELLOW = '\033[93m'
    BLUE = '\033[94m'
    END = '\033[0m'

def print_test(name):
    print(f"\n{Colors.BLUE}{'='*60}{Colors.END}")
    print(f"{Colors.BLUE}ğŸ§ª Test: {name}{Colors.END}")
    print(f"{Colors.BLUE}{'='*60}{Colors.END}")

def print_success(message):
    print(f"{Colors.GREEN}âœ… {message}{Colors.END}")

def print_error(message):
    print(f"{Colors.RED}âŒ {message}{Colors.END}")

def print_warning(message):
    print(f"{Colors.YELLOW}âš ï¸  {message}{Colors.END}")

def print_info(message):
    print(f"   {message}")

# Test results tracker
results = {
    "passed": 0,
    "failed": 0,
    "warnings": 0
}

# =============================================
# TEST 1: API Availability
# =============================================
def test_api_availability():
    print_test("API Availability")
    
    try:
        response = requests.get(f"{BASE_URL}/", timeout=TIMEOUT)
        
        if response.status_code == 200:
            print_success("API is accessible")
            data = response.json()
            print_info(f"API Version: {data.get('version', 'unknown')}")
            print_info(f"Status: {data.get('status', 'unknown')}")
            results["passed"] += 1
            return True
        else:
            print_error(f"API returned status code: {response.status_code}")
            results["failed"] += 1
            return False
            
    except requests.exceptions.ConnectionError:
        print_error("Cannot connect to API")
        print_info("Make sure API is running: python app.py")
        results["failed"] += 1
        return False
    except Exception as e:
        print_error(f"Error: {e}")
        results["failed"] += 1
        return False

# =============================================
# TEST 2: Health Check
# =============================================
def test_health_check():
    print_test("Health Check")
    
    try:
        response = requests.get(f"{BASE_URL}/health", timeout=TIMEOUT)
        data = response.json()
        
        if response.status_code == 200:
            print_success("Health check passed")
            
            # Check components
            components = data.get('components', {})
            for component, status in components.items():
                if status:
                    print_info(f"âœ“ {component}: OK")
                else:
                    print_warning(f"âœ— {component}: NOT LOADED")
                    results["warnings"] += 1
            
            print_info(f"Database size: {data.get('database_size', 0)} chunks")
            print_info(f"Vector count: {data.get('vector_count', 0)}")
            
            results["passed"] += 1
            return True
        else:
            print_error(f"Health check failed: {response.status_code}")
            results["failed"] += 1
            return False
            
    except Exception as e:
        print_error(f"Error: {e}")
        results["failed"] += 1
        return False

# =============================================
# TEST 3: Ask Endpoint - Valid Question
# =============================================
def test_ask_valid_question():
    print_test("Ask Endpoint - Valid Question")
    
    question = "What is PM-KISAN scheme?"
    
    try:
        start_time = time.time()
        response = requests.post(
            f"{BASE_URL}/ask",
            json={"question": question},
            timeout=TIMEOUT
        )
        elapsed_time = time.time() - start_time
        
        if response.status_code == 200:
            data = response.json()
            
            if data.get('success'):
                print_success("Question answered successfully")
                print_info(f"Question: {question}")
                print_info(f"Answer length: {len(data.get('answer', ''))} characters")
                print_info(f"Sources: {data.get('num_sources', 0)}")
                print_info(f"LLM used: {data.get('llm_used', False)}")
                print_info(f"Response time: {elapsed_time:.2f}s")
                
                # Show first 200 chars of answer
                answer = data.get('answer', '')
                if answer:
                    print_info(f"Answer preview: {answer[:200]}...")
                
                results["passed"] += 1
                return True
            else:
                print_error(f"API returned success=false: {data.get('error')}")
                results["failed"] += 1
                return False
        else:
            print_error(f"Status code: {response.status_code}")
            results["failed"] += 1
            return False
            
    except Exception as e:
        print_error(f"Error: {e}")
        results["failed"] += 1
        return False

# =============================================
# TEST 4: Ask Endpoint - Empty Question
# =============================================
def test_ask_empty_question():
    print_test("Ask Endpoint - Empty Question (Error Handling)")
    
    try:
        response = requests.post(
            f"{BASE_URL}/ask",
            json={"question": ""},
            timeout=TIMEOUT
        )
        
        if response.status_code == 400:
            print_success("Empty question correctly rejected")
            data = response.json()
            print_info(f"Error message: {data.get('error')}")
            results["passed"] += 1
            return True
        else:
            print_warning(f"Expected 400, got {response.status_code}")
            results["warnings"] += 1
            return False
            
    except Exception as e:
        print_error(f"Error: {e}")
        results["failed"] += 1
        return False

# =============================================
# TEST 5: Ask Endpoint - Missing Field
# =============================================
def test_ask_missing_field():
    print_test("Ask Endpoint - Missing Field (Error Handling)")
    
    try:
        response = requests.post(
            f"{BASE_URL}/ask",
            json={"query": "test"},  # Wrong field name
            timeout=TIMEOUT
        )
        
        if response.status_code == 400:
            print_success("Missing field correctly rejected")
            data = response.json()
            print_info(f"Error message: {data.get('error')}")
            results["passed"] += 1
            return True
        else:
            print_warning(f"Expected 400, got {response.status_code}")
            results["warnings"] += 1
            return False
            
    except Exception as e:
        print_error(f"Error: {e}")
        results["failed"] += 1
        return False

# =============================================
# TEST 6: Search Endpoint
# =============================================
def test_search_endpoint():
    print_test("Search Endpoint")
    
    try:
        response = requests.post(
            f"{BASE_URL}/search",
            json={"query": "crop insurance", "top_k": 3},
            timeout=TIMEOUT
        )
        
        if response.status_code == 200:
            data = response.json()
            
            if data.get('success'):
                print_success("Search completed successfully")
                print_info(f"Query: crop insurance")
                print_info(f"Results found: {data.get('count', 0)}")
                
                # Show first result
                results_list = data.get('results', [])
                if results_list:
                    first = results_list[0]
                    print_info(f"Top result score: {first.get('score', 0):.3f}")
                    print_info(f"Chunk preview: {first.get('chunk', '')[:100]}...")
                
                results["passed"] += 1
                return True
            else:
                print_error(f"Search failed: {data.get('error')}")
                results["failed"] += 1
                return False
        else:
            print_error(f"Status code: {response.status_code}")
            results["failed"] += 1
            return False
            
    except Exception as e:
        print_error(f"Error: {e}")
        results["failed"] += 1
        return False

# =============================================
# TEST 7: Stats Endpoint
# =============================================
def test_stats_endpoint():
    print_test("Stats Endpoint")
    
    try:
        response = requests.get(f"{BASE_URL}/stats", timeout=TIMEOUT)
        
        if response.status_code == 200:
            data = response.json()
            
            if data.get('success'):
                print_success("Stats retrieved successfully")
                
                db_info = data.get('database', {})
                print_info(f"Total chunks: {db_info.get('total_chunks', 0)}")
                print_info(f"Vector dimension: {db_info.get('vector_dimension', 0)}")
                print_info(f"Embedding model: {db_info.get('embedding_model', 'unknown')}")
                
                api_info = data.get('api', {})
                print_info(f"LLM available: {api_info.get('llm_available', False)}")
                
                results["passed"] += 1
                return True
            else:
                print_error(f"Stats failed: {data.get('error')}")
                results["failed"] += 1
                return False
        else:
            print_error(f"Status code: {response.status_code}")
            results["failed"] += 1
            return False
            
    except Exception as e:
        print_error(f"Error: {e}")
        results["failed"] += 1
        return False

# =============================================
# TEST 8: Multiple Questions (Load Test)
# =============================================
def test_multiple_questions():
    print_test("Multiple Questions (Load Test)")
    
    questions = [
        "What is PM-KISAN?",
        "How do I apply for crop insurance?",
        "What is Kisan Credit Card?"
    ]
    
    success_count = 0
    total_time = 0
    
    try:
        for i, question in enumerate(questions, 1):
            start_time = time.time()
            response = requests.post(
                f"{BASE_URL}/ask",
                json={"question": question},
                timeout=TIMEOUT
            )
            elapsed_time = time.time() - start_time
            total_time += elapsed_time
            
            if response.status_code == 200 and response.json().get('success'):
                success_count += 1
                print_info(f"âœ“ Question {i}: {elapsed_time:.2f}s")
            else:
                print_warning(f"âœ— Question {i} failed")
        
        if success_count == len(questions):
            print_success(f"All {len(questions)} questions answered")
            print_info(f"Average response time: {total_time/len(questions):.2f}s")
            results["passed"] += 1
            return True
        else:
            print_warning(f"Only {success_count}/{len(questions)} succeeded")
            results["warnings"] += 1
            return False
            
    except Exception as e:
        print_error(f"Error: {e}")
        results["failed"] += 1
        return False

# =============================================
# MAIN TEST RUNNER
# =============================================
def main():
    print("\n" + "="*60)
    print("ğŸ§ª API COMPREHENSIVE TEST SUITE")
    print("="*60)
    print(f"Target API: {BASE_URL}")
    print(f"Timeout: {TIMEOUT}s")
    
    # Run all tests
    test_api_availability()
    test_health_check()
    test_ask_valid_question()
    test_ask_empty_question()
    test_ask_missing_field()
    test_search_endpoint()
    test_stats_endpoint()
    test_multiple_questions()
    
    # Print summary
    print("\n" + "="*60)
    print("ğŸ“Š TEST SUMMARY")
    print("="*60)
    
    total_tests = results["passed"] + results["failed"] + results["warnings"]
    
    print(f"\n{Colors.GREEN}âœ… Passed: {results['passed']}/{total_tests}{Colors.END}")
    print(f"{Colors.RED}âŒ Failed: {results['failed']}/{total_tests}{Colors.END}")
    print(f"{Colors.YELLOW}âš ï¸  Warnings: {results['warnings']}/{total_tests}{Colors.END}")
    
    success_rate = (results['passed'] / total_tests * 100) if total_tests > 0 else 0
    print(f"\nğŸ“ˆ Success Rate: {success_rate:.1f}%")
    
    if results['failed'] == 0:
        print(f"\n{Colors.GREEN}ğŸ‰ ALL CRITICAL TESTS PASSED!{Colors.END}")
        print("Your API is ready for production use.")
    elif results['failed'] <= 2:
        print(f"\n{Colors.YELLOW}âš ï¸  SOME TESTS FAILED{Colors.END}")
        print("API is functional but has issues to address.")
    else:
        print(f"\n{Colors.RED}âŒ MULTIPLE TEST FAILURES{Colors.END}")
        print("Please fix critical issues before proceeding.")
    
    print("\nğŸ’¡ Recommendations:")
    if results['warnings'] > 0:
        print("   - Check warnings above")
    if results['failed'] > 0:
        print("   - Review failed tests")
        print("   - Check API logs for errors")
        print("   - Verify all dependencies installed")
    
    print("\n" + "="*60 + "\n")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\nâš ï¸  Tests interrupted by user\n")
    except Exception as e:
        print(f"\nâŒ Test suite error: {e}\n")